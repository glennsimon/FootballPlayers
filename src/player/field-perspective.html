<html>
  <head> </head>
  <body>
    <div class="value_entry">
      <label for="psi">psi (rad):</label>
      <input type="text" id="psi" name="psi" />
      <label for="theta">theta (rad):</label>
      <input type="text" id="theta" name="theta" />
      <label for="perspective">perspective (px):</label>
      <input type="text" id="perspective" name="perspective" />
    </div>
    <div class="shifter">
      <div class="outline"></div>
      <!-- <div class="outline2"></div>
      <div class="outline3"></div> -->
      <div class="wrapper">
        <div class="floorZ">
          <div class="floor">
            <div class="field">
              <div class="field-objective"></div>
              <div class="fifty"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const fieldWidth = 2040;
      const fieldHeight = 920;
      const viewportWidth = 1280;
      const viewportHeight = 720;
      // let zScale = 2.173;
      let zScale = 1;
      let playerVector = [320, 320, 0];
      let lookAt = [
        (fieldWidth / 2 + playerVector[0]) / 2,
        (fieldHeight / 2 + playerVector[1]) / 2,
        8 * zScale,
      ];
      const cameraVector = [
        fieldWidth / 2,
        fieldHeight / 2 + 640,
        400 * zScale,
      ];
      let sightlineVector = cameraVector.map((item, index) => {
        return item - lookAt[index];
      });
      let sightlineDistance =
        (sightlineVector[0] ** 2 +
          sightlineVector[1] ** 2 +
          sightlineVector[2] ** 2) **
        0.5;
      let sightUnitVector = sightlineVector.map((item, index) => {
        return item / sightlineDistance;
      });
      const fieldUnitVector = [0, 0, 1];
      let transformVector = sightUnitVector.map((item, index) => {
        return item - fieldUnitVector[index];
      });
      // angle from horizontal down to lookAt (rad)
      let psi =
        Math.PI / 2 -
        Math.atan(
          sightlineVector[2] /
            (sightlineVector[0] ** 2 + sightlineVector[1] ** 2) ** 0.5
        );
      // camera rotation angle about vertical (rad)
      let theta = Math.atan(sightlineVector[0] / sightlineVector[1]);

      const holding = `transform-origin: ${cameraVector[0]}px ${
        cameraVector[1]
      }px;
        transform: perspective(${sightlineDistance}px) translateY(200px) rotateX(${psi}rad) rotateZ(${theta}rad) translate3d(0px, 0px, 0px)
        left: ${640 - lookAt[0]}px;
        top: ${360 - lookAt[1]}px;
        transform-origin: ${lookAt[0]}px ${lookAt[1]}px;
        ;`;

      const style = document.createElement('style');
      style.innerHTML = `
      * {
        box-sizing: border-box;
        position: absolute;
        backface-visibility: inherit;
        font-family: fantasy;
        // transform-style: preserve-3d;
      }
      body {
        margin: 0;
        padding: 0;
        background: transparent;
      }
      .shifter {
        left: 320px;
        top: 180px;
      }
      label, input {
        position: relative;
        z-index: 10;
      }
      .wrapper {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
      }
      .outline {
        left: 0;
        top: 0;
        width: ${viewportWidth}px;
        height: ${viewportHeight}px;
        background: rgba(255,0,0,0.3);
      }
      .outline2 {
        left: -${viewportWidth / 2};
        top: -${viewportHeight / 2};
        width: ${2 * viewportWidth}px;
        height: ${2 * viewportHeight}px;
        background: rgba(255,255,0,0.3);
      }
      .outline3 {
        left: -${viewportWidth};
        top: -${viewportHeight};
        width: ${3 * viewportWidth}px;
        height: ${3 * viewportHeight}px;
        background: rgba(255,0,255,0.3);
      }
      // .floorZ {
      //   transform-origin: ${lookAt[0]}px ${lookAt[1]}px;
      //   transform: perspective(800px) rotateZ(0rad);
      // }
      // .floor {
      //   transform-origin:
      // }
      .field {
        left: ${viewportWidth / 2 - lookAt[0]}px;
        top: ${viewportHeight / 2 - lookAt[1]}px;
        width: ${fieldWidth}px;
        height: ${fieldHeight}px;
        background: url('./field.jpg');
        background-size: cover;
        // background-color: rgba(0, 255, 0, 0.3);
        // transform-origin: ${lookAt[0]}px ${lookAt[1]}px;
        // transform: perspective(800px) rotateZ(0rad) rotate3d(0rad);
        // transform: perspective(800px) rotateZ(${theta}rad) rotate3d(0.86,0.5,0,${psi}rad);
      }
      .field-objective {
        left: ${lookAt[0] - 10}px;
        top: ${lookAt[1] - 10}px;
        width: 20px;
        height: 20px;
        background: white;
        clip-path: polygon(
          9px 0, 11px 0, 11px 9px, 20px 9px, 20px 11px,
          11px 11px, 11px 20px, 9px 20px, 9px 11px, 0px 11px,
          0px 9px, 9px 9px, 9px 0 );
      }
      .fifty {
        left: ${fieldWidth / 2 - 2}px;
        top: 0;
        width: 4px;
        height: ${fieldHeight}px;
        background: white;
      }
      `;
      document.head.appendChild(style);

      let tempStyle = document.createElement('style');
      tempStyle.id = 'field_transform';
      tempStyle.innerHTML = `.field {
        transform-origin: ${lookAt[0]}px ${lookAt[1]}px;
        perspective-origin: ${lookAt[0]}px ${lookAt[1]}px;
        transform: perspective(${sightlineDistance}px) rotateZ(${theta}rad) rotate3d(${Math.cos(
        theta
      )}, -${Math.sin(theta)}, 0, ${psi}rad);
      }
      `;
      document.head.appendChild(tempStyle);

      const psiVal = document.querySelector('#psi');
      psiVal.value = psi;
      const thetaVal = document.querySelector('#theta');
      thetaVal.value = theta;
      const perspVal = document.querySelector('#perspective');
      perspVal.value = sightlineDistance;
      psiVal.addEventListener('change', changeAngle);
      thetaVal.addEventListener('change', changeAngle);
      perspVal.addEventListener('change', changeAngle);

      function changeAngle(e) {
        tempStyle.remove();
        tempStyle = document.createElement('style');
        tempStyle.id = 'field_transform';
        tempStyle.innerHTML = `.field {
        transform-origin: ${lookAt[0]}px ${lookAt[1]}px;
        perspective-origin: ${lookAt[0]}px ${lookAt[1]}px;
        transform: perspective(${perspVal.value}px) rotateZ(${
          thetaVal.value
        }rad) rotate3d(${Math.cos(thetaVal.value)}, -${Math.sin(
          thetaVal.value
        )}, 0, ${psiVal.value}rad);
      }
      `;
        document.head.appendChild(tempStyle);
      }
    </script>
  </body>
</html>
